{% import "fmt" %}
{% import "strings" %}
{% import "github.com/nanzhong/tstr/db" %}

{% code
type TestsPage struct {
    TestsByLabel []db.UITestsByLabelsRow
    ResultsByTest map[string][]db.RunResult
    Tests []db.Test
    TestRunsByTestID map[string][]db.UIListRecentRunsRow
}
%}

{% func (p *TestsPage) Title() %}
tstr - tests
{% endfunc %}




{% func testRunBadge(testRun db.UIListRecentRunsRow ) %}
    <a href="/runs/{%s testRun.ID.String() %}">
          {% if testRun.Result == db.RunResultPass %}
              <span class="badge bg-success">&nbsp;</span>
          {% elseif testRun.Result == db.RunResultFail %}
              <span class="badge bg-danger">&nbsp;</span>
          {% elseif testRun.Result == db.RunResultError %}
              <span class="badge bg-danger">E</span>
          {% elseif testRun.Result == db.RunResultUnknown %}
              <span class="badge bg-warning">?</span>
          {% endif %}
      </a>
{% endfunc %}

{% func (p *TestsPage) Body() %}

<div class="tests">
{% for _, test := range p.Tests %}
  <div class="row mb-2">
    <div class="col">
      <h2 class="h4"><a href="/tests/{%s test.ID.String() %}">{%s test.Name %}</a></h2>
      {% for _, testRun := range p.TestRunsByTestID[test.ID.String()] %}

      {%= testRunBadge(testRun) %}

      {% endfor %}
    </div>
  </div>


{% endfor %}

</div>

<div class="packages">
{% for _, byLabel := range p.TestsByLabel  %}
{% code 

 labelsAsString := strings.Join(labelsAsSlice(byLabel.Labels,": ")," ")
%}
  <div class="row mb-2">
    <div class="col">
      <h2 class="h4"><a href="/labels/{%s fmt.Sprintf("TODO") %}">{%s labelsAsString %}</a></h2>
      {% for _, test := range byLabel.Tests.([]string)  %}
        {% for _, result := range p.ResultsByTest[test] %}

            {% if result == db.RunResultPass %}
            <span class="badge bg-success">&nbsp;</span>
            {% else %}
            <span class="badge bg-danger">&nbsp;</span>
            {% endif %}
        {% endfor %}
      {% endfor  %}
    </div>
  </div>
{% endfor %}
</div>
{% endfunc %}

